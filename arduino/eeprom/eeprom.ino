#include <EEPROM.h>

// Permission modes
#define PERMISSION_MODE_STANDARD 1
#define PERMISSION_MODE_NOPISCINE 2
#define PERMISSION_MODE_STAFF 3
#define PERMISSION_MODE_MOVIEROOM 4

// EEPROM contents
struct    s_config {
  byte door_id;
  byte permission_mode;

  byte id_mac_key[0x20];
  byte tk_mac_key[0x20];
};

#define DOOR_ID 0
#define PERMISSION_MODE PERMISSION_MODE_STANDARD

#define DEBUG_MODE true

byte g_id_mac_key[0x20] = {
#if DEBUG_MODE
  0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
  0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
  0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
  0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A
#else
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
#endif
};

byte g_tk_mac_key[0x20] = {
#if DEBUG_MODE
  0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42,
  0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42,
  0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42,
  0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42
#else
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
#endif
};

#define STRUCT_IDX(T,field) (int)&(((T *)0)->field)

void setup() {
  Serial.begin(9600);
  while (!Serial) {
    ; // wait for serial port to connect
  }

  Serial.println("Writing door id...");
  EEPROM.write(STRUCT_IDX(s_config, door_id), DOOR_ID);

  Serial.println("Writing permission mode...");
  EEPROM.write(STRUCT_IDX(s_config, permission_mode), PERMISSION_MODE);

  Serial.println("Writing keys...");
  for (int i = 0; i < 0x20; i++) {
    EEPROM.write(STRUCT_IDX(s_config, id_mac_key) + i, g_id_mac_key[i]);
    EEPROM.write(STRUCT_IDX(s_config, tk_mac_key) + i, g_tk_mac_key[i]);
  }

  //TODO: populate the eeprom with more information than just keys and a door id
  //TODO: validate the written data

  Serial.println("EEPROM has been properly formatted.");
}

void loop() {
}

